exports.up = (knex: any) => {
  if (knex.userParams.isSetup) {
    return Promise.resolve()
  }
  return knex.schema.createView('public.vulnerability_has_cve', (view: any) => {
    view.columns(['id', 'cve', 'name', 'description', 'remediation'])
    view.as(
      knex({ vu: 'public.vulnerability' })
        .select({
          id: 'vu.id',
          cve: knex.raw("ARRAY_TO_STRING(ARRAY_AGG(rf.value), ', ')"),
          name: 'vu.name',
          description: 'vu.description',
          remediation: 'vu.remediation',
        })
        .leftJoin({ rf: 'public.reference' }, function(this: any) {
          this.on('rf.vulnerability_id', '=', 'vu.id').andOn(
            'rf.type',
            '=',
            knex.raw('?', ['cve'])
          )
        })
        .groupBy('vu.id', 'vu.name', 'vu.description', 'vu.remediation')
    )
  });
}
exports.down = (knex: any) => {
  return knex.schema.dropViewIfExists('public.vulnerability_has_cve')
}
