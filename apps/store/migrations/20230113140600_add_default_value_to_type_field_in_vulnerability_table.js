// @ts-check

/**
 *
 * @param {import("knex").Knex} knex
 * @returns
 */
exports.up = async (knex) => {
  // If already setup, ignore
  if (knex.userParams.isSetup)
    return Promise.resolve()

  await knex.raw(`
  UPDATE vulnerability_asset
  SET exploit_available = FALSE
  WHERE exploit_available is NULL ;
`)
  await knex.raw(`
  UPDATE vulnerability_asset
  SET exploit_framework_core = FALSE
  WHERE exploit_framework_core is NULL ;
`)
  await knex.raw(`
  UPDATE vulnerability_asset
  SET exploited_by_malware = FALSE
  WHERE exploited_by_malware is NULL ;
`)
  await knex.raw(`
    UPDATE vulnerability_asset
    SET status = 'open'
    WHERE status is NULL ;
  `)

  await knex.raw(`
    ALTER TABLE vulnerability_asset
    ALTER COLUMN exploit_available SET DEFAULT FALSE;
  `)
  await knex.raw(`
    ALTER TABLE vulnerability_asset
    ALTER COLUMN exploit_framework_core SET DEFAULT FALSE;
  `)
  await knex.raw(`
    ALTER TABLE vulnerability_asset
    ALTER COLUMN exploited_by_malware SET DEFAULT FALSE;
  `)
  await knex.raw(`
    ALTER TABLE vulnerability_asset
    ALTER COLUMN status SET DEFAULT 'open';
  `)
}
/**
 *
 * @param {import("knex").Knex} knex
 * @returns
 */
exports.down = (knex) => {
  return knex.schema.alterTable('vulnerability_asset', function (table) {
    table.boolean('exploit_available').defaultTo(null).alter();
    table.boolean('exploit_framework_core').defaultTo(null).alter();
    table.boolean('exploited_by_malware').defaultTo(null).alter();
    table.string('status').defaultTo(null).alter();
  })
}
