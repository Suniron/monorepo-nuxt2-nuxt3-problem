<template>
  <v-form v-model="isFormValid">
    <v-text-field
      v-model="form.name"
      placeholder="Vulnerability Title"
      label="Vulnerability Title"
      :rules="rules.default"
    ></v-text-field>
    <h3>Description :</h3>
    <quill-editor
      :content="form.description"
      :options="editorOption"
      @change="onDescChange($event)"
    />
    <br />
    <h3>Remediation :</h3>
    <quill-editor
      :content="form.remediation"
      :options="editorOption"
      @change="onRemChange($event)"
    />
    <br />
    <v-combobox
      v-model="form.cves"
      label="List of CVE"
      @change="validateCves"
      solo
      multiple
      chips
      deletable-chips
    />
    <v-combobox
      v-model="form.urls"
      label="List of References"
      @change="validateRefs"
      solo
      multiple
      chips
      deletable-chips
    />
    <v-row>
      <v-col cols="12">
        <v-btn class="mr-2" :disabled="isLoading" @click.stop="$emit('close')">
          Cancel
        </v-btn>
        <v-btn
          color="primary"
          @click.stop="saveVuln"
          :disabled="!isFormValid"
          :loading="isLoading"
        >
          Save
        </v-btn>
      </v-col>
    </v-row>
  </v-form>
</template>
<script>
import 'quill/dist/quill.core.css'
import 'quill/dist/quill.snow.css'
import 'quill/dist/quill.bubble.css'
import { quillEditor } from 'vue-quill-editor'
// import VulnerabilityRefItem from './vulnerability-ref-item.vue'
import _ from 'lodash'

export default {
  components: { quillEditor },
  data() {
    return {
      isFormValid: false,
      isLoading: false,
      form: {
        name: '',
        description: '',
        remediation: '',
        urls: [],
        cves: []
      },
      rules: {
        default: [(v) => !!v || 'Required field']
      },
      editorOption: {
        // Some Quill options...
      }
    }
  },
  methods: {
    onDescChange({ quill, html, text }) {
      this.form.description = html
    },
    onRemChange({ quill, html, text }) {
      this.form.remediation = html
    },
    validateCves(cves) {
      this.form.cves = cves.filter((e) => /CVE-[\d]{4}-[\d]+/.test(e))
    },
    validateRefs(refs) {
      this.form.urls = refs.filter((e) => /https?:\/\/[\S]+/.test(e))
      console.log(this.form.urls)
    },
    saveVuln() {
      this.$emit('save', _.cloneDeep(this.form))
      Object.assign(this.$data, this.$options.data.call(this))
    }
  }
}
</script>
<style>
pre {
  white-space: normal;
}
</style>
