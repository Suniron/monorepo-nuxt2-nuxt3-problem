<template>
  <v-card class="d-flex flex-column">
    <v-card-title
      >Vulnerabilities History<v-spacer></v-spacer
      ><v-icon @click="$emit('close')">mdi-close</v-icon></v-card-title
    >
    <v-card-text class="dash-text d-flex justify-center overflow-y-auto">
      <stacked-bar-chart
        id="scans-history-dashboard"
        v-if="hasChartData"
        :data="chartData"
        :config="chartConfig"
      />
      <div v-else>No results to display.</div>
    </v-card-text>
  </v-card>
</template>

<script>
// import StackedBarChart from '~/components/charts/stacked-bar-chart'
import StackedBarChart from '../charts/stacked-bar-chart.vue'

export default {
  name: 'VulnerabilityHistory',
  components: { StackedBarChart },
  middleware: ['auth'],
  props: {
    data: {
      type: Array,
      required: true
    }
  },
  data: () => ({
    chartData: {
      x: {
        value: []
      },
      low: {
        value: [],
        color: '#f0d802'
      },
      medium: {
        value: [],
        color: '#ed9b0e'
      },
      high: {
        value: [],
        color: '#d92b2b'
      },
      critical: {
        value: [],
        color: '#941e1e'
      }
    },
    chartConfig: {
      data: {
        x: 'x',
        order: (a, b) => {
          const orders = {
            low: 0,
            medium: 1,
            high: 2,
            critical: 3
          }

          return orders[a.id] - orders[b.id]
        }
      }
    }
  }),
  computed: {
    hasChartData() {
      return Object.values(this.chartData).every((group) => group.value.length)
    }
  },
  watch: {
    data(newScans) {
      this.fetchScansChartData(newScans)
    }
  },
  created() {
    this.fetchScansChartData(this.data)
  },
  methods: {
    fetchScansChartData(scans) {
      this.chartData = scans.reduce(
        (data, scan) => {
          const date = new Date(scan.sdate)
          // const dateString = date.toISOString()
          // console.log(date)
          data.x.value.push(date)
          data.low.value.push(scan.low)
          data.medium.value.push(scan.medium)
          data.high.value.push(scan.high)
          data.critical.value.push(scan.critical)
          return data
        },
        {
          x: {
            value: []
          },
          low: {
            value: [],
            color: '#f0d802'
          },
          medium: {
            value: [],
            color: '#ed9b0e'
          },
          high: {
            value: [],
            color: '#d92b2b'
          },
          critical: {
            value: [],
            color: '#941e1e'
          }
        }
      )
    }
  }
}
</script>

<style lang="scss">
.vulnerabilities-heat-map {
  .heat-map {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    row-gap: 8px;

    &_column-header {
      font-weight: 600;
      text-align: center;
    }

    &_row-header {
      font-weight: 600;
    }

    &_cell {
      cursor: pointer;
      text-align: center;
      font-weight: 500;
      &:hover {
        background: #b0b0b01c;
      }

      &--safe {
        color: #60b044;
      }
      &--warning {
        color: #ed9b0e;
      }
      &--danger {
        color: #d92b2b;
      }
      &--critical {
        color: #941e1e;
      }
    }
  }
}
</style>
