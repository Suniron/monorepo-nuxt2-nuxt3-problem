<template>
  <v-container>
    <v-row>
      <v-col cols="2">
        <v-text-field
          v-model="search"
          class="my-2"
          append-icon="mdi-magnify"
          label="Search"
          single-line
          hide-details
        />
      </v-col>
    </v-row>
    <v-data-table
      :headers="headers"
      :items="items"
      :search="search"
      :item-class="() => 'scan-vuln-row'"
      @click:row="goToVuln"
      :options="{ sortBy: ['severity'], sortDesc: [true] }"
      :items-per-page="5"
      class="elevation-1"
    ></v-data-table>
  </v-container>
</template>

<script>
import { severityLevelString } from '~/utils/risk.utils'

const SEVERITY_WEIGHT = {
  critical: 5,
  high: 4,
  medium: 3,
  low: 2,
  info: 1
}

export default {
  props: {
    vulnerabilities: {
      type: Array,
      required: true
    },
    assetVulnerabilities: {
      type: Array,
      required: true
    }
  },
  data() {
    return {
      search: '',
      headers: [
        {
          text: 'Severity',
          value: 'severity',
          sort: (a, b) => {
            return SEVERITY_WEIGHT[a] - SEVERITY_WEIGHT[b]
          }
        },
        {
          text: 'Vulnerabilitiy name',
          value: 'vulnerability_name'
        },
        {
          text: 'Asset count',
          value: 'asset_count'
        }
      ]
    }
  },
  computed: {
    /**
     * @returns {Array}
     */
    items() {
      return this.vulnerabilities.map((vuln) => {
        return {
          severity: vuln.severity || severityLevelString(vuln.cvss_score),
          vulnerability_name: vuln.name,
          asset_count: this.assetVulnerabilities
            .filter((av) => av.vulnerability_id === vuln.id)
            .reduce((acc, av) => {
              if (acc.includes(av.asset_id)) return acc
              acc.push(av.asset_id)
              return acc
            }, []).length
        }
      })
    }
  },
  methods: {
    goToVuln(item) {
      this.$router.push(
        this.localePath({
          name: 'vulnerabilities',
          query: {
            search: item.vulnerability_name
          }
        })
      )
    }
  }
}
</script>

<style>
.scan-vuln-row {
  cursor: pointer;
}
</style>
