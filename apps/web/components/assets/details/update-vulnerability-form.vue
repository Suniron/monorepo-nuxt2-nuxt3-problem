<template>
  <div style="padding:1em">
    <v-form v-model="isFormValid">
      <v-row>
        <v-col cols="12" xl="5" lg="5">
          <h3>Affected IP*</h3>
          <v-select v-model="form.ip" :items="ips" item-text="address" />
        </v-col>
        <v-col cols="12" xl="5" lg="5">
          <h3>Affected Ports*</h3>
          <v-select
            v-model="selectedPort"
            return-object
            :items="portsForSelectedAddress"
            :item-text="(port) => port.number + '/' + port.protocol"
          />
        </v-col>
        <v-col cols="12" xl="5" lg="12">
          <h3>Custom description : *</h3>
          <quill-editor
            :content="form.custom_description"
            :options="editorOption"
            @change="onDescChange($event)"
          />
          <br />
          <h3>Custom remediation : *</h3>
          <quill-editor
            :content="form.custom_remediation"
            :options="editorOption"
            @change="onRemChange($event)"
          />
          <br />
          <h3>Details: *</h3>
          <quill-editor
            :content="form.details"
            :options="editorOption"
            @change="onEvidChange($event)"
          />
        </v-col>
        <v-col cols="12" xl="7" lg="12">
          <cvss-calculator
            :already-has-informations="item"
            @change="changeCVSS"
          />
        </v-col>
      </v-row>

      <v-row>
        <v-col cols="12">
          <v-btn class="mr-2" :disabled="isLoading" @click.stop="cancel">
            Cancel
          </v-btn>
          <v-btn
            color="primary"
            @click.stop="saveVuln"
            :disabled="
              !isFormValid ||
                form.code === '' ||
                form.details === '' ||
                form.score === 0
            "
            :loading="isLoading"
          >
            Save
          </v-btn>
          (*) : field required.
        </v-col>
      </v-row>
    </v-form>
  </div>
</template>
<script>
import { uuid } from 'vue-uuid'
import 'quill/dist/quill.core.css'
import 'quill/dist/quill.snow.css'
import 'quill/dist/quill.bubble.css'
import { quillEditor } from 'vue-quill-editor'
import CvssCalculator from '~/components/assets/details/cvss-calculator.vue'
import { searchVulnerabilitiesWithTheirAssetsService } from '~/services/vulnerabilities'
import {
  fetchAssetsPortsService,
  updateSpecialPortInAssetVulnerabilities
} from '~/services/assets'

export default {
  components: { CvssCalculator, quillEditor },
  props: {
    assetId: {
      type: Number,
      required: true
    },
    item: {
      type: Object,
      required: true
    },
    itemvulN: {
      type: Object,
      required: true
    }
  },
  data() {
    return {
      isFormValid: false,
      isLoading: false,
      form: {
        ip: '',
        port: undefined,
        protocol: undefined,
        vulnId: null,
        vulnerability_id: null,
        name: '',
        custom_description: '',
        custom_remediation: '',
        details: '',
        code: '',
        score: 0.0,
        version: 3.1,
        ips: [this.createIpItem()]
      },
      rules: {
        default: [(v) => !!v || 'Field is required']
      },
      vulns: [],
      ports: [],
      ips: [],
      score: '0.0',
      severity: 'Severity',
      color: 'grey',
      editorOption: {
        // Some Quill options...
      }
    }
  },
  computed: {
    selectedPort: {
      get() {
        return {
          number: this.form.port,
          protocol: this.form.protocol
        }
      },
      set({ number, protocol }) {
        this.form.port = number
        this.form.protocol = protocol
      }
    },
    portsForSelectedAddress() {
      return this.ports.filter((port) => {
        return port.address === this.form.ip
      })
    }
  },
  watch: {
    item() {
      this.form = this.item
      this.fetchVulnerabilities()
      this.fetchPorts()
    },
    portsForSelectedAddress() {
      if (
        this.ports.length > 0 &&
        this.form.port !== undefined &&
        this.form.protocol !== undefined &&
        !this.portsForSelectedAddress.find(
          (port) =>
            port.number === this.form.port &&
            port.protocol === this.form.protocol
        )
      ) {
        this.selectedPort = {
          number: undefined,
          protocol: undefined
        }
      }
    }
  },
  created() {
    this.resetData()
  },
  methods: {
    resetData() {
      this.form = this.item
      this.fetchVulnerabilities()
      this.fetchPorts()
    },
    async fetchVulnerabilities() {
      const data = await searchVulnerabilitiesWithTheirAssetsService(
        this.$axios,
        {}
      )
      this.vulns = data.vulnerabilities
    },
    async fetchPorts() {
      const data = await fetchAssetsPortsService(this.$axios, this.assetId)
      this.ports = data
        .filter((ipPort) => ipPort.number !== undefined)
        .map((ipPort) => ({
          address: ipPort.address,
          number: ipPort.number,
          protocol: ipPort.protocol
        }))
      this.ips = Array.from(data, (x) => x.address)
    },
    createIpItem() {
      return { id: uuid.v4(), address: '', ports: [] }
    },
    async saveVuln() {
      this.form.cvss_code = this.form.code
      this.form.cvss_score = this.form.score
      await updateSpecialPortInAssetVulnerabilities(this.$axios, this.form)
      this.$root.$emit('ModalForModification', false)
      this.$root.$emit('handleChangeOnVulnForm', this.form, this.itemvulN)
    },
    cancel() {
      this.$root.$emit('ModalForModification', false)
      this.resetData()
    },
    change(data) {
      this.severity = data.severity
      this.score = data.score
      this.color = data.color
    },
    changeCVSS(form) {
      this.form = { ...this.form, ...form }
    },
    onDescChange({ quill, html, text }) {
      this.form.custom_description = html
    },
    onRemChange({ quill, html, text }) {
      this.form.custom_remediation = html
    },
    onEvidChange({ quill, html, text }) {
      this.form.details = html
    },
    ipValidator(ip) {
      return /^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(
        ip
      )
    }
  }
}
</script>
