<script>
import { uuid } from 'vue-uuid'
import 'quill/dist/quill.core.css'
import 'quill/dist/quill.snow.css'
import 'quill/dist/quill.bubble.css'
import { quillEditor } from 'vue-quill-editor'
import CvssCalculator from '~/components/assets/details/cvss-calculator.vue'
import { searchVulnerabilitiesService } from '~/services/vulnerabilities'
import {
  createAssetVulnerability,
  fetchAssetsPortsService,
} from '~/services/assets'
import IpPortItem from '~/components/assets/details/ip-port-item.vue'

export default {
  components: { CvssCalculator, IpPortItem, QuillEditor: quillEditor },
  data() {
    return {
      isFormValid: false,
      isLoading: false,
      form: {
        vulnId: null,
        vulnerability_id: null,
        name: '',
        description: '',
        remediation: '',
        details: '',
        code: '',
        score: 0.0,
        version: 3.1,
        ips: [this.createIpItem()],
        uris: [{ id: uuid.v4(), address: '' }]
      },
      rules: {
        default: [(v) => !!v || 'Field is required']
      },
      vulns: [],
      ports: [],
      ips: [],
      uris: [],
      score: '0.0',
      severity: 'Severity',
      color: 'grey',
      editorOption: {
        // Some Quill options...
      }
    }
  },
  props: {
    asset: {
      type: Object,
      required: true
    },
    selectedAsset: {
      type: Array,
      required: false
    },
    isOpen: {
      type: Boolean,
      required: false
    }
  },
  watch: {
    // whenever isOpen is becoming true, this function will run
    isOpen(newVal) {
      if (newVal) this.fetchPorts()
    }
  },
  created() {
    this.fetchVulnerabilities()
    this.fetchPorts()
  },
  methods: {
    change(data) {
      this.severity = data.severity
      this.score = data.score
      this.color = data.color
    },
    changeCVSS(form) {
      this.form = { ...this.form, ...form }
    },
    changeItem(form) {
      if (this.asset.type === 'SERVER') {
        if (form.ipId) {
          const idx = this.form.ips.findIndex(e => e.id === form.id)
          this.form.ips[idx] = {
            address: form.ipId.address,
            id: form.id,
            ip_id: form.ipId.ip_id,
            ports: form.ports,
          }
        }
      }
    },
    createIpItem() {
      return { address: '', id: uuid.v4(), ports: [] }
    },
    createUriItem() {
      this.form.uris.push({ address: '', id: uuid.v4() })
    },
    deleteItem(id) {
      this.form.ips.splice(
        this.form.ips.findIndex(e => e.id === id),
        1,
      )
    },
    deleteUriItem(item) {
      this.form.uris = this.form.uris.filter(e => e.id !== item.id)
    },
    async fetchPorts() {
      const temporaryIpArray = []
      this.ips = []
      if (this.selectedAsset === undefined) {
        const data = await fetchAssetsPortsService(this.$axios, this.asset.id)
        this.ports = data
        this.ips = Array.from(data, x => x.address).map((e) => {
          return { address: e, ip_id: data.find(s => s.address === e).ip_id }
        })
      }
      else {
        for (const asset of this.selectedAsset) {
          const data = await fetchAssetsPortsService(this.$axios, asset.id)
          this.ips = Array.from(data, x => x.address).map((e) => {
            return {
              address: e,
              ip_id: data.find(s => s.address === e).ip_id,
            }
          })
          temporaryIpArray.push(this.ips)
        }
        this.ips = [...temporaryIpArray.flat()]
      }
    },
    async fetchVulnerabilities() {
      const data = await searchVulnerabilitiesService(this.$axios, {})
      this.vulns = data.vulnerabilities
    },
    onDescChange({ quill, html, text }) {
      this.form.description = html
    },
    onEvidChange({ quill, html, text }) {
      this.form.details = html
    },
    onRemChange({ quill, html, text }) {
      this.form.remediation = html
    },
    async saveVuln() {
      if (this.selectedAsset === undefined) {
        this.form.vulnerability_id = this.form.vulnId.id
        this.form.ips = this.form.ips.filter(e => e.address !== '')
        this.form.uris = this.form.uris.filter(e => e.address !== '')
        await createAssetVulnerability(this.$axios, this.asset.id, this.form)
      }
      else {
        for (const asset of this.selectedAsset) {
          this.form.vulnerability_id = this.form.vulnId.id
          this.form.ips = this.form.ips.filter(e => e.address !== '')
          this.form.uris = this.form.uris.filter(e => e.address !== '')
          for (const ip of this.form.ips) {
            // We might add several ips, so, we need to check if the ip already exists in the asset.ips
            // but, looking for the ID is not working, because the address hasnt unique id, in database it look like
            // 1 - 127.0.0.1 - 1(for the asset_id)
            // 2 - 127.0.0.1 - 2 (for the asset_id)
            // So, we prefer to check if the address is already in the array
            const tempoArray = asset.ips.filter(e => e.address === ip.address)
            if (tempoArray.length === 0) {
              // if its not, we put the ip_id to null, because we need to create a new one
              ip.ip_id = null
            }
            else {
              // if it exists, we want to get the ID affiliate to the address on the current asset, and not the one selected in the v select
              // because we're not showing duplicate address on the v select
              ip.ip_id
                = asset.ips.find(e => e.address === ip.address).id ?? ip.ip_id
            }
          }
          await createAssetVulnerability(this.$axios, asset.id, this.form)
        }
      }
      this.$emit('close')
      this.$root.$emit('fetchDataAgain')
    },
    vulnChange() {
      if (typeof this.form.vulnId === 'string') {
        this.form.name = this.form.vulnId
        this.form.description = ''
        this.form.remediation = ''
      }
      else {
        this.form.name = this.form.vulnId.name
        this.form.description = this.form.vulnId.description
        this.form.remediation = this.form.vulnId.remediation
      }
    },
  },
}
</script>

<template>
  <div>
    <v-form v-model="isFormValid">
      <v-row>
        <v-col cols="12" xl="5" lg="12">
          <v-combobox
            v-model="form.vulnId"
            :items="vulns"
            placeholder="Select a vulnerability *"
            item-text="name"
            :rules="rules.default"
            @change="vulnChange"
          />
          <div v-if="asset.type === 'SERVER'">
            <IpPortItem
              v-for="(IP, i) in form.ips"
              :key="i"
              :item="IP"
              :ips="ips"
              :ports="ports"
              :first="i === 0"
              @add="form.ips.push(createIpItem())"
              @delete="deleteItem"
              @change="changeItem"
            />
          </div>

          <div v-if="asset.type === 'WEB'">
            <div
              v-for="(item, index) in form.uris"
              :key="index"
              style="display: flex"
            >
              <v-text-field v-model="item.address" label="Affected Uri *" />
              <v-btn v-if="index === 0" icon>
                <v-icon color="primary" @click="createUriItem()">
                  mdi-plus-circle-outline
                </v-icon>
              </v-btn>
              <v-btn v-if="index !== 0" icon>
                <v-icon color="primary" @click="() => deleteUriItem(item)">
                  mdi-delete
                </v-icon>
              </v-btn>
            </div>
            <h3>Default confidence :</h3>
            <v-text-field v-model="form.confidence" />
            <br>
          </div>

          <h3>Default description : *</h3>
          <QuillEditor
            :content="form.description"
            :options="editorOption"
            @change="onDescChange($event)"
          />
          <br>
          <h3>Default remediation : *</h3>
          <QuillEditor
            :content="form.remediation"
            :options="editorOption"
            @change="onRemChange($event)"
          />
          <br>
          <h3>Evidence: *</h3>
          <QuillEditor
            :content="form.details"
            :options="editorOption"
            @change="onEvidChange($event)"
          />
        </v-col>
        <v-col cols="12" xl="7" lg="12">
          <CvssCalculator @change="changeCVSS" />
        </v-col>
      </v-row>

      <v-row>
        <v-col cols="12">
          <v-btn
            class="mr-2"
            :disabled="isLoading"
            @click.stop="$emit('close')"
          >
            {{ $t('action.cancel') }}
          </v-btn>
          <v-btn
            color="primary"
            :disabled="
              !isFormValid
                || form.code === ''
                || form.details === ''
                || form.score === 0
            "
            :loading="isLoading"
            @click.stop="saveVuln"
          >
            {{ $t('action.save') }}
          </v-btn>
          (*) : field required.
        </v-col>
      </v-row>
    </v-form>
  </div>
</template>

<style scoped>
.ql-editor {
  height: 100px;
}
</style>
